<!doctype html>
<html>
<head>
<title>imgplay2-</title>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/start/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script>
// resolve conflict between bootstrap .button() and jquery-ui .button()
var bootstrapButton = $.fn.button.noConflict(); // return $.fn.button to previously assigned value
$.fn.bootstrapBtn = bootstrapButton;            // give $().bootstrapBtn the Bootstrap functionality
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery.ui-contextmenu/1.10.0/jquery.ui-contextmenu.min.js"></script>
<script>
//----------------------------------------------------------------------
//-- guarantees that window.name is a GUID, and that it would
//-- be preserved during this window's life time
//----------------------------------------------------------------------
//-- window.name will be set to "GUID-<SOME_RANDOM_GUID>"
//----------------------------------------------------------------------
function guid () {
	function s4 () { return Math.floor( Math.random() * 0x10000 /* 65536 */ ).toString(16); }
    return s4() + s4() + "-" + s4() + "-" + s4() + "-" + s4() + "-" + s4() + s4() + s4();
}
if (!window.name.match(/^GUID-/)) {
    window.name = "GUID-" + guid();
}
/**
 * Provides requestAnimationFrame in a cross browser way.
 * http://paulirish.com/2011/requestanimationframe-for-smart-animating/
 */
if ( !window.requestAnimationFrame ) {
	window.requestAnimationFrame = (function() {
		return window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		function( /* function FrameRequestCallback */ callback, /* DOMElement Element */ element ) {
			window.setTimeout( callback, 1000 / 60 );
		};
	})();
}
/**
 * OOP class inheritance.
 */
function deriveFrom (child, parent) {
	child.prototype = Object.create(parent.prototype);
	child.prototype.baseclass = parent.prototype;
	child.prototype.constructor = child; // Reset the constructor from parent to child
}
/**
 * String hash code (Java style)
 */
String.prototype.hashCode = function () {
	var hash = 0, len = this.length;
	for (var i = 0; i < len; i++) {
		hash = ((hash << 5) - hash) + this.charCodeAt(i);
		hash |= 0; // Convert to 32bit integer
	}
	return hash >>> 0; // return unsigned
};
/**
 * htmlEncode()
 */
String.prototype.replaceAll = function(str1, str2, ignore) {
	return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),(ignore?"gi":"g")),(typeof(str2)=="string")?str2.replace(/\$/g,"$$$$"):str2);
};
function htmlEncode(str) { return str.replaceAll('&', '&amp;').replaceAll('"', '&quot;').replaceAll("'", '&#39;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }
/**
 * String to hex and hex to string.
 */
String.prototype.hexEncode = function () {
	var hex, i;
	var result = "";
	for (i=0; i<this.length; i++) {
		hex = this.charCodeAt(i).toString(16);
		result += ("000"+hex).slice(-4);
	}
	return result;
}
String.prototype.hexDecode = function () {
	var j;
	var hexes = this.match(/.{1,4}/g) || [];
	var back = "";
	for(j = 0; j<hexes.length; j++) {
		back += String.fromCharCode(parseInt(hexes[j], 16));
	}
	return back;
}
function encodeId (id) {
	return id.replace(/[:\.]/g, "$&$&")
		.replace(/[^A-Za-z0-9_:\.]/g, function (match) {
			var c = match.charCodeAt(0);
			if (c < 16)	return ".0" + c.toString(16);
			if (c < 256)	return "." + c.toString(16);
			if (c < 4096)	return ":0" + c.toString(16);
			return ":" + c.toString(16);
		});
}
function decodeId (str) {
	return str.replace(/(^|[^\.])\.([A-Fa-f0-9]{2})/g, function (match, p1, p2) { return p1 + String.fromCharCode(parseInt(p2, 16)); })
		.replace(/(^|[^:]):([A-Fa-f0-9]{4})/g, function (match, p1, p2) { return p1 + String.fromCharCode(parseInt(p2, 16)); })
		.replace(/::|\.\./g, function (match) { return String.fromCharCode(match.charCodeAt(0)); });
}
function jqId ( id ) { return id.replace( /(:|\.|\[|\]|,)/g, "\\$1" ); }
function strCompare(str1, str2) { return str1 > str2 ? 1 : str1 < str2 ? -1 : 0; }
function $trimVal(selector) {
	var $txt = $(selector).first(), _val = $txt.val(), val = $.trim(_val);
	if (val !== _val)
		$txt.val(val);
	return val;
}
</script>
<style>
	.ui-resizable-handle { cursor: nw-resize; }
	.ui-button { /*float: right;*/ display: inline-block; cursor: pointer; /*margin-bottom: -3px;*/ }
	.ui-right { vertical-align: top; float: right; }

	input[type=checkbox] { width: 8px; height: 8px; }

/*************** round checkbox stuff ***************
	.roundCheckbox input[type=checkbox] { width: 3px; height: 3px; visibility: hidden; margin: 0; }
	.roundCheckbox {
		display: inline-block;
		vertical-align: -4px;
		
		width: 12px;
		height: 12px;
		background: #ddd;
		margin-bottom: -2px;

		border-radius: 100%;
		position: relative;
		-webkit-box-shadow: 0px 1px 3px rgba(0,0,0,0.5);
		-moz-box-shadow: 0px 1px 3px rgba(0,0,0,0.5);
		box-shadow: 0px 1px 3px rgba(0,0,0,0.5);
	}
	.roundCheckbox label {
		display: block;
		width: 9px;
		height: 9px;
		border-radius: 100px;

		-webkit-transition: all .5s ease;
		-moz-transition: all .5s ease;
		-o-transition: all .5s ease;
		-ms-transition: all .5s ease;
		transition: all .5s ease;
		cursor: pointer;
		position: absolute;
		top: 2px;
		left: 2px;

		background: #333;

		-webkit-box-shadow:inset 0px 1px 3px rgba(0,0,0,0.5);
		-moz-box-shadow:inset 0px 1px 3px rgba(0,0,0,0.5);
		box-shadow:inset 0px 1px 3px rgba(0,0,0,0.5);
	}
	.roundCheckbox input[type=checkbox]:checked + label {
		background: #26ca28;
	}
	.roundCheckbox input[type=checkbox]:disabled + label {
		background: #bbb;
		cursor: default;
	}
*************** end round checkbox ****************/

	body { /*color: #508; line-height: 1.2;*/ }

	.contCenter {  text-align: center; /*margin-top: 50%; float: none;*/ }

	.contRightTop { width: 20%; float: right; clear: both; margin: 4px 4px 0px 0px; min-width: 85px; }
	.boxHead { text-align: center; /*white-space: nowrap;*/ min-width: 85px; }
	/*#playbackContainer .ui-icon { background-image: url("//code.jquery.com/ui/1.11.4/themes/black-tie/images/ui-icons_ededed_256x240.png"); }*/

	.contCheckbox { white-space: nowrap; }
	.contCheckbox input[type=checkbox] { /*width: 3px; height: 3px; visibility: hidden; margin: 0;*/ display: none; }
	.contCheckbox label {
		-webkit-transition: all .5s ease;
		-moz-transition: all .5s ease;
		-o-transition: all .5s ease;
		-ms-transition: all .5s ease;
		transition: all .5s ease;
		cursor: pointer;
		color: #333;
	}
	.contCheckbox input[type=checkbox]:checked + label {
		color: #26ca28;
	}
	.contCheckbox input[type=checkbox]:disabled + label {
		color: #bbb;
		cursor: default;
	}
	.contCheckbox.unconfirmed input[type=checkbox] + label {
		color: #bbb;
	}
	.contCheckbox.unconfirmed input[type=checkbox]:checked + label {
		color: #e05050;
	}

	.dropdown { display: inline-block; }
	.dropdown select { border-width: 0; }
	
	label.-bs-icon- { margin-bottom: 0; }
	
	.ui-contextmenu, .dropdown-menu { font-size: 80%; z-index: 150; }
	.dropdown-menu { padding-right: 2px; }
	.menu-container { /*clear: both;*/ text-align: right; white-space: nowrap; }
	.menu-label { margin-left: 2px; display: inline-block; /*text-align: left;*/ float: left; }
	
	.hidden { display: none; }
</style>
</head>
<body>
<object id="img-applet-ie"
  classid="clsid:8AD9C840-044E-11D1-B3E9-00805F499D93"
  width="100" height="40" style="position:absolute;left:-1000px;top:-1000px;">
  <param name="archive" value="img-applet.jar">
  <param name="code" value="img_applet.ImgApplet">
  <param name="java_status_events" value="true">
  <!-- <param name="debug" value="yes"> -->
  <comment>
    <embed id="img-applet"
      type="application/x-java-applet"
      width="100" height="40" style="position:absolute;left:-1000px;top:-1000px;" 
      archive="img-applet.jar"
      code="img_applet.ImgApplet"
      pluginspage="http://java.com/download/"
      java_status_events="true" /><!-- 
      debug="yes" -->
  </comment>
</object>
<div id="sign-in-panel">
<div class="container">
<div class="form-inline form-group contCenter">
	<label for="enter-your-name-txt">Please enter your name</label>
	<input class="form-control" type="text" id="enter-your-name-txt" title="Enter Your Name" />
	<button type="button" id="enter-your-name-btn" class="btn btn-default" title="Enter the Chat Room" onclick="enterButtonClick(this);">Enter</button>
</div>
</div>
</div>
<div id="video-chat-panel" style="display:none;">
	<div id="deviceContainer" class="contRightTop">
		<div class='boxHead ui-state-default ui-corner-all' style='/*background-color:cyan;*/'>
			Capture
			<span class='ui-icon ui-icon-arrowrefresh-1-w ui-button ui-right' title='Refresh Audio/Video Devices'></span>
		</div>
		<div></div>
	</div>
	<div id="playbackContainer" class="contRightTop">
		<div class='boxHead ui-state-default ui-corner-all' style='/*background-color:magenta;color:white;*/'>
			Playback
			<span class='ui-icon ui-icon-arrowrefresh-1-w ui-right' title='Refresh Audio/Video Streams'></span>
		</div>
		<div></div>
	</div>
	<div id="textchatContainer" class="contRightTop">
		<div class='boxHead ui-state-default ui-corner-all' style='/*background-color:cyan;*/'>
			Chat
			<span class='ui-icon ui-icon-arrowrefresh-1-w ui-right' title='Refresh Text Chat'></span>
		</div>
		<div>
			<textarea id='text-chat-text' class='form-control input-sm' rows='5'></textarea>
			<input type='checkbox' id='text-chat-timestamp' style='/*float:right;*//*font-size:90%;*/width:10px;height:10px;' /> 
			<label for='text-chat-timestamp' style='/*float:right;*/font-size:90%;'>Timestamp</label>
			<button type="button" id="text-chat-btn" title="Send" style='float:right;font-size:80%;'><!--  class="btn btn-default btn-xs" -->
				<i class='fa fa-send-o'></i>
				Send
			</button>
			<div id="textContainer" style='clear:both;/*overflow:auto;*/'>
			</div>
		</div>
	</div>
</div>
<script>

$(function () {
	$('#enter-your-name-txt').keypress(function (e) {
		var code = e.keyCode || e.which;
		if (code === 13) {
			e.preventDefault();
			enterButtonClick(document.getElementById('enter-your-name-btn'));
		}
	}).focus();
});

function enterButtonClick(e) {
	$('#sign-in-panel').find('.alert').remove();
	var val = $trimVal('#enter-your-name-txt');
	if (val)
	{
		$.ajax({
			url: 'http://' + getRtmpHostname() + '/rest/vchat/' + encodeURIComponent(val) + '/' + encodeURIComponent(window.name),
			cache: false,
			dataType: 'json'
		}).then(function (data) {
			$('#sign-in-panel').css('display', 'none');
			$('#video-chat-panel').css('display', '');
			registerAppletStateHandler();
		}, function (error) {
			$('<div class="alert alert-warning" role="alert" style="margin-top:10px;">' + error.responseText + '</div>').insertAfter(e);
		});
	}
}

// global variables
var applets = [ document.getElementById( 'img-applet' ), document.getElementById( 'img-applet-ie' ) ],
	_applet,
	sn = 0,
	ffmpeg_ids = {},
	current_device_name = {},
	videos = {},
	keys = {}, // by ffmpeg_id
	name_hash = {}, // by ffmpeg_id
	audio_level = {}; // by name_hash

function checkAppletMethod(applet, method) { return applet && (!method || (applet[method] || typeof(applet[method]) === "unknown")); }

function checkApplet(applet, applet_ie, method) { if (!_applet) { if (applet && applet.createFFmpeg) { _applet = applet; } else if (applet_ie && typeof(applet_ie.createFFmpeg) === "unknown") { _applet = applet_ie; } } return checkAppletMethod(_applet, method); }

function registerAppletStateHandler() {
	var READY = 2;
	// register onLoad handler if applet has not loaded yet
	if (checkApplet(applets[0], applets[1])) {
		if (_applet.status < READY)  {
			_applet.onload = onLoadHandler;
		} else if (_applet.status >= READY) {
			// applet has already loaded or there was an error
			onLoadHandler();
		}
	}
}

function createVideoCanvas (container, resizable) {
	var image, videoImage, $videoImageContainer, videoImageContext, last_img = -1;
	function createImage() { return $('<img style="visibility: hidden; display: none;" />').appendTo(container)[0]; }
	image = [ createImage(), createImage() ];
	if (resizable)
		$videoImageContainer = $("<div class='video-container' style='position:absolute;width:0px;height:0px;'></div>").appendTo(container);
	videoImage = $("<canvas width='0' height='0'></canvas>").appendTo($videoImageContainer || container)[0];
	// create '2d' context; background color if no video present
	videoImageContext = videoImage.getContext( '2d' );
	videoImageContext.fillStyle = '#005337';
	videoImageContext.fillRect( 0, 0, videoImage.width, videoImage.height );				
	// assign image elements onload handler
	var setDimensions = true, curImageIndex;
	image[0].onload = image[1].onload = function() {
		if (setDimensions) {
			setDimensions = false;
			videoImage.width = this.width;
			videoImage.height = this.height;
			if ($videoImageContainer) {
				$videoImageContainer.width(this.width);
				$videoImageContainer.height(this.height);
				$videoImageContainer.data( "size", { width: this.width, height: this.height } );
			}
			if (resizable)
				$videoImageContainer.draggable().resizable({
					aspectRatio: this.width / this.height/*,
					resize: function(event, ui) {
						image[0].width = image[1].width = videoImage.width = ui.size.width;
						image[0].height = image[1].height = videoImage.height = ui.size.height;
						videoImageContext.drawImage( image[curImageIndex], 0, 0, videoImage.width, videoImage.height );
					}*/
				}).on( "resize", function(event, ui) {
					image[0].width = image[1].width = videoImage.width = ui.size.width;
					image[0].height = image[1].height = videoImage.height = ui.size.height;
					videoImageContext.drawImage( image[curImageIndex], 0, 0, videoImage.width, videoImage.height );
				});
		}
		curImageIndex = this === image[0] ? 0 : 1;
		videoImageContext.drawImage( this, 0, 0, videoImage.width, videoImage.height );
	};
	return {
		drawUri:	function (uri) { image[last_img = (last_img + 1) % 2].src = uri; },
		destroy:	function () { ($videoImageContainer || $(videoImage)).remove(); $(image[0]).remove(); $(image[1]).remove(); }
	};
}

function checkboxClick(checkbox) {
	_applet[checkbox.checked?'play':'stopPlayback'](ffmpeg_ids[checkbox.id]);
}
function checkboxCallback(ffmpeg_id, playing) {
	var key = keys[ffmpeg_id];
	if (key)
		document.getElementById(key).checked = playing;
}

function audioLevelCallback(ffmpeg_id, level) {
	//console.log("audio level " + level);
	var _name_hash = name_hash[ffmpeg_id];
	audio_level[_name_hash] = level;
	window.setTimeout(function () { $('#a' + _name_hash).css(audioLevelCss(level)); }, 0);
}
function audioLevelCss(level) {
	var _level = level < 0 ? 0 : level > 10 ? 10 : level, _pct = (10 - _level) * 10;
	return { 'background': 'linear-gradient(90deg, #ffffff ' + _pct + '%, #26ca28 ' + _pct + '%)' };
}

function removeFFmpeg(key) {
	var ffmpeg_id = ffmpeg_ids[key];
	if (ffmpeg_id) {
		_applet.stopPlayback(ffmpeg_id);
		_applet.removeFFmpegById(ffmpeg_id);
		delete ffmpeg_ids[key];
		delete current_device_name[key];
		if (videos[key])
			videos[key].destroy();
		delete videos[key];
		delete keys[ffmpeg_id];
		delete name_hash[ffmpeg_id];
	}
}

function recreateFFmpeg(key, callback, param_arr) {
	var playing = false;
	var ffmpeg_id = ffmpeg_ids[key];
	if (ffmpeg_id) {
		playing = _applet.isPlaying(ffmpeg_id);
		removeFFmpeg(key);
	}
	ffmpeg_id = ffmpeg_ids[key] = _applet.createFFmpegId(callback, param_arr);
	keys[ffmpeg_id] = key;
	name_hash[ffmpeg_id] = namesFromKey(key).name.hashCode();
	if (playing)
		_applet.play(ffmpeg_id);
}

var _op = {
	capture_video: 1,
	playback_video: 2,
	capture_audio: 3,
	playback_audio: 4,
	list_devices: 5,
	list_options: 6,
	capture_screen: 7
};

function renewFFmpeg(op, key, p1, p2) {
	switch (op) {

	case _op.capture_video: recreateFFmpeg( key, 'checkboxCallback', [
			//'ffmpeg-r', '25',
			'ffmpeg-f:i', 'dshow',
			'ffmpeg-i', 'video=' + p1,		// video device, e.g. "Logitech QuickCam E3500"
			'ffmpeg-c:v', 'libx264',
			'ffmpeg-preset', 'ultrafast',
			'ffmpeg-tune', 'zerolatency',
			//'ffmpeg-pix_fmt', 'yuv422p', // 'yuv420p',
			'ffmpeg-g', '50',
			'ffmpeg-an', '',
			'ffmpeg-f:o', 'flv',
			'ffmpeg-o', p2,			// rtmp url, e.g. "rtmp://10.44.43.244/rtmp/v"
			'debug', 'yes',
			'debug-ffmpeg', debugFFmpeg(), // 'yes',
		] ); current_device_name[key] = p1; break;

	case _op.playback_video: recreateFFmpeg( key, 'checkboxCallback', [
			//"ffmpeg-re", "",
			//"ffmpeg-f:i", "",
			"ffmpeg-i", p1,			// rtmp url, e.g. "rtmp://10.44.43.244/rtmp/v",
			//"ffmpeg-i", "rtmp://europaplus.cdnvideo.ru:1935/europaplus-live/eptv_main.sdp",
			//"ffmpeg-i", "rtmp://85.132.78.6:1935/live/muztv.stream",
			//"ffmpeg-i", "http://83.139.104.101/Content/HLS/Live/Channel(Sk_1)/index.m3u8",
			//"ffmpeg-map", "0:6",
			"ffmpeg-c:v", "mjpeg",
			"ffmpeg-q:v", "0.0",
 /* ‘-vsync parameter’
    Video sync method. For compatibility reasons old values can be specified as numbers. 
    Newly added values will have to be specified as strings always.
    ‘0, passthrough’ - Each frame is passed with its timestamp from the demuxer to the muxer. 
    ‘1, cfr’ - Frames will be duplicated and dropped to achieve exactly the requested constant frame rate. 
    ‘2, vfr’ - Frames are passed through with their timestamp or dropped so as to prevent 2 frames from having the same timestamp. 
    ‘drop’ - As passthrough but destroys all timestamps, making the muxer generate fresh timestamps based on frame-rate. 
    ‘-1, auto’ - Chooses between 1 and 2 depending on muxer capabilities. This is the default method.
  */
			"ffmpeg-vsync", "0",
			"ffmpeg-f:o", "mjpeg",
			"ffmpeg-an", "",
			//"ffmpeg-muxpreload", "10",
			//"ffmpeg-muxdelay", "10",
			//"ffmpeg-loglevel", "warning",
			"drop-unused-frames", "yes",
			"debug", "yes",
			"debug-ffmpeg", debugFFmpeg(), // 'yes',
		] ); videos[key] = createVideoCanvas(p2, true); break; // p2 - container's selector or jQuery object

	case _op.capture_audio: recreateFFmpeg( key, 'checkboxCallback', [
			'ffmpeg-f:i', 'dshow',
			'ffmpeg-audio_buffer_size', '50',
			'ffmpeg-i', 'audio=' + p1,		// audio device, e.g. "Microphone (USB Audio Device)"
			'ffmpeg-c:a', 'libmp3lame',
			'ffmpeg-async', '1',
			'ffmpeg-vn', '',
			'ffmpeg-f:o', 'flv',
			'ffmpeg-o', p2,			// rtmp url, e.g. "rtmp://10.44.43.244/rtmp/a"
			'debug', 'yes',
			'debug-ffmpeg', debugFFmpeg(), // 'yes',
		] ); current_device_name[key] = p1; break;

	case _op.playback_audio: recreateFFmpeg( key, 'checkboxCallback', [
			"ffmpeg-re", "no",
			"ffmpeg-analyzeduration", "1000",
			"ffmpeg-rtmp_buffer", "0",
			"ffmpeg-rtmp_live", "live",
			//"ffmpeg-f:i", "",
			"ffmpeg-i", p1,			// rtmp url, e.g. "rtmp://10.44.43.244/rtmp/a"
			//"ffmpeg-c:a", "libmp3lame",
			//"ffmpeg-f:o", "mp3",
			//"mp3-frames-per-chunk", "1",
			"ffmpeg-f:o", "wav",
			"ffmpeg-vn", "",
			//"wav-audio-line-buffer-size", "2200",
			"wav-intermediate-buffer-size", "32",
			"wav-level-change-callback", "audioLevelCallback",
			"debug", "yes",
			"debug-ffmpeg", debugFFmpeg(), // 'yes',
		] ); break;

	case _op.capture_screen: recreateFFmpeg( key, 'checkboxCallback', [
			//'ffmpeg-r', '25',
			'ffmpeg-f:i', 'gdigrab',
			'ffmpeg-video_size', '1024x768', // '800x600',
			'ffmpeg-show_region', '1',
			'ffmpeg-i', 'desktop',
			'ffmpeg-c:v', 'libx264',
			'ffmpeg-preset', 'ultrafast',
			'ffmpeg-tune', 'zerolatency',
			//'ffmpeg-pix_fmt', 'yuv422p', // 'yuv420p',
			'ffmpeg-g', '50',
			'ffmpeg-an', '',
			'ffmpeg-f:o', 'flv',
			'ffmpeg-o', p1,			// rtmp url, e.g. "rtmp://10.44.43.244/rtmp/s"
			'debug', 'yes',
			'debug-ffmpeg', debugFFmpeg(), // 'yes',
		] ); break;
	}
}

function callFFmpeg(op, p1) {
	var _ffmpeg_id, defer = $.Deferred().always(function () {
		if (_ffmpeg_id) {
			_applet.removeFFmpegById(_ffmpeg_id);
			//alert("remove: " + _ffmpeg_id);
		}
	});
	window.dataCallback = function (ffmpeg_id, playing) {
		if (!playing) {
			defer.resolve(_applet.getStderrData(ffmpeg_id));
			//alert("resolve: " + ffmpeg_id);
		}
	};
	switch (op) {

	case _op.list_devices: _ffmpeg_id = _applet.createFFmpegId( 'dataCallback', [
			'ffmpeg-list_devices', 'true',
			'ffmpeg-f:i', 'dshow',
			'ffmpeg-i', 'dummy',
			'ffmpeg-o', '',
			'debug', debugFFmpeg(), // 'yes',
		] ); break;

	case _op.list_options: _ffmpeg_id = _applet.createFFmpegId( 'dataCallback', [
			'ffmpeg-list_options', 'true',
			'ffmpeg-f:i', 'dshow',
			'ffmpeg-i', p1,			// device, e.g. 'video=Logitech QuickCam Communicate STX', or 'audio=Logitech Mic (Communicate STX)'
			'ffmpeg-o', '',
			'debug', debugFFmpeg(), // 'yes',
		] ); break;
	}
	if (_ffmpeg_id) {
		_applet.play(_ffmpeg_id);
	}
	return defer.promise();
}

function debugFFmpeg() { return window.location.search && window.location.search.indexOf('debug-ffmpeg') != -1 ? 'yes' : 'no'; }

function getRtmpHostname() { return window.location.hash && window.location.hash.length > 7 ? window.location.hash.substring(1) : window.location.hostname; }

function getMyName() { return $('#enter-your-name-txt').val(); }

function getMyRtmpAppName(deviceType) { return getMyName() + '|' + deviceType; }

function getStreamInfo(rtmpAppName) { var p = rtmpAppName.lastIndexOf("|"); return { name: rtmpAppName.substring(0, p > -1 ? p : rtmpAppName.length), deviceType: p > -1 ? rtmpAppName.substring(p + 1) : "" }; }

function deviceTypeOrder(a) { return a === "audio" ? 1 : a === "video" ? 2 : a === "screen" ? 3 : -1; }

function orderToDeviceType(n) { return n == 1 ? "audio" : n == 2 ? "video" : n == 3 ? "screen" : "unknown"; }

function deviceToStreamType(a) { return a === "audio" ? "audio" : a === "video" ? "video" : a === "screen" ? "video" : "video"; }

function keyFromNames(deviceType, opName, name) { return (opName || "capture") + "-" + encodeId(name || "my") + "-" + deviceType; }

function namesFromKey(key) { var tmp = key.split('-'); return { opName: tmp[0], name: decodeId(tmp[1]), deviceType: tmp[2] }; }

function onLoadHandler() {
	// event handler for ready state
	var rtmp_hostname = getRtmpHostname();
	function getRtmpUrl(rtmp_app) { return 'rtmp://' + rtmp_hostname + '/rtmp/' + encodeURIComponent(rtmp_app); }
	// FFmpeg UI functions
	function getCheckeds() { var checkeds = {}; for (var key in ffmpeg_ids) checkeds[key] = $("#" + jqId(key)).is(":checked"); return checkeds; }
	function create$ffmpegUi(deviceType, checkeds, opName, name) {
		if (!checkeds) checkeds = {};
		var key = keyFromNames(deviceType, opName, name), 
			icon = '<i class="fa fa-' + (deviceType==='audio'?'microphone':deviceType==='video'?'video-camera':deviceType==='screen'?'desktop':'camera') + '"></i>';
		return $(
			'<span class="contCheckbox">' +
				'<span> </span>' +
				//'<label for="' + key + '">' + icon + '</label>' +
				//'<span> </span>' +
				//'<div class="roundCheckbox">' +
					'<input id="' + key + '" type="checkbox" onclick="checkboxClick(this)"' + (checkeds[key] ? ' checked="checked"' : '') + ' />' +
					//'<label for="' + key + '">' + '</label>' +
				//'</div>' +
				'<label for="' + key + '" class="-bs-icon-">' + icon + '</label>' +
				//'<span>&nbsp;</span>' +
			'</span>');
	}
	function lineHtml(name) {
		return "<div style='text-align:right;'><span style='float:left;text-align:left;font-weight:bold;/*min-width:50%;*/'>" +
			htmlEncode(name) +
			"</span></div>";
	}
	var cardinalPoints = [ "n", "e", "s", "w" ], arrowrefreshClasses = $.map(cardinalPoints, function (val, i) { return "ui-icon-arrowrefresh-1-" + val; }), arrowrefreshClassStr = arrowrefreshClasses.join(" ");
	// list devices
	var ldCnt = 0;
	function listDevices () {
		$("#deviceContainer select").css("visibility", "hidden");
		callFFmpeg(_op.list_devices).then(function (res) {
			// DeviceType class
			function DeviceType(deviceType) {
				this.deviceType = deviceType;
				this.key = keyFromNames(deviceType);
				this.$ffmpegUi = create$ffmpegUi(deviceType, checkeds);
			}
			DeviceType.prototype.appendTo = function(container) { this.$ffmpegUi.appendTo(container); return this; };
			DeviceType.prototype.renew = function() {
				if (!checkeds[this.key])
					renewFFmpeg(_op["capture_" + this.deviceType], this.key, getRtmpUrl(getMyRtmpAppName(this.deviceType)));
			};
			// DirectShowDevice class
			deriveFrom(DirectShowDevice, DeviceType);
			function DirectShowDevice(deviceType) {
				this.baseclass.constructor.call(this, deviceType);
				this.devices = [];
				this.$dropdown = $(
					'<div class="dropdown">' +
						'<a id="'+ this.key + '-trigger" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
							'<span class="caret"></span>' +
						'</a>' +
						'<div class="dropdown-menu pull-right" aria-labelledby="'+ this.key + '-trigger">' +
							'<div class="menu-container">' +
								'<select></select>' +
							'</div>' +
						'</div>' +
					'</div>');
				var self = this;
				this.$select = this.$dropdown.find("select").change(function () { self._updateDevice($(this).val()); });
				this.$div = this.$select.parent();
				this.$dropdown.insertAfter(this.$ffmpegUi.find("label"));
			}
			DirectShowDevice.prototype._getDevice = function(deviceName) {
				for (var i = 0; i < this.devices.length; i++)
					if (this.devices[i].name === deviceName)
						return this.devices[i];
			};
			DirectShowDevice.prototype.renew = function() {
				if (current_device_name[this.key] && this._getDevice(current_device_name[this.key])) {
					this.$select.val(current_device_name[this.key]);
				}
				this._updateDevice(this.$select.val());
			};
			DirectShowDevice.prototype._updateDevice = function(deviceName) {
				var self = this;
				this._getOptions(deviceName).then(function (options) {
					self._updateDropdownUi(options);
					self._updateFFmpeg(deviceName);
					self._updateUi(deviceName);
				});
			};
			DirectShowDevice.prototype._getOptions = function(deviceName) {
				var _device;
				return $.when(this.deviceType === "video" && (_device = this._getDevice(deviceName)) && (_device.options || callFFmpeg(_op.list_options, this.deviceType + "=" + _device.name).then(function (res) {
					// parse DirectShow output
					var re = /\[\s*dshow\s*@\s*[a-fA-F0-9]+\s*\]\s*"?(.*?)"?\s*\r?\n/ig, match, arr = [];
					while ((match = re.exec(res)) !== null) {
						arr.push(match[1]);
					}
					re = /^\s*(pixel_format|vcodec)\s*=\s*(.*?)\s+min\s+s\s*=\s*(.*?)\s+fps\s*=\s*(.*?)\s+max\s+s\s*=\s*(.*?)\s+fps\s*=\s*(.*?)\s*$/i;
					// add DirectShow device options
					var tmp = {};
					for (var i in arr) {
						if (re.test(arr[i]) && !tmp[arr[i]]) {
							tmp[arr[i]] = arr[i]; // filter out duplicates
							if (!_device.options)
								_device.options = [];
							match = re.exec(arr[i]);
							if (res.type !== match[1] || res.name !== match[2]) {
								_device.options.push(res = { type: match[1], name: match[2], type_name: match[1] + "=" + match[2], options: [] });
							}
							res.options.push({ min_s: match[3], min_fps: parseInt(match[4]), max_s: match[5], max_fps: parseInt(match[6]),
								s: match[3], px: eval(match[3].replace("x","*")) });
						}
					}
					return _device.options
				})));
			};
			DirectShowDevice.prototype._findOption = function(options, value, name) {
				if (!name)
					name = "type_name";
				for (var i in options)
					if (options[i][name] === value)
						return options[i];
			};
			DirectShowDevice.prototype._updateDropdownUi = function(options) {
				if (options) {

					function $menuContainer(insertAfter, label) {
						return $("<div class='menu-container'></div>").insertAfter(insertAfter)
							.append("<div class='menu-label'>" + label + ":</div>");
					}

					if (!this.$select2)
						this.$select2 = $("<select></select").appendTo(this.$div2 = $menuContainer(this.$div, "Mode"));
					this.$select2.empty();
					for (var i in options)
						$("<option></option>").attr("value", options[i].type_name).text(/*options[i].type + ": " + options[i].name*/options[i].type_name).appendTo(this.$select2);

					if (!this.$select3)
						this.$select3 = $("<select></select").appendTo(this.$div3 = $menuContainer(this.$div2, "Resolution"));
					this.$select3.empty();
					var option = this._findOption(options, this.$select2.val());
					if (option) {
						var arr = option.options.slice();
						arr.sort(function (p1, p2) { return p1.px - p2.px; });
						for (var i in arr)
							$("<option></option>").attr("value", arr[i].s).text(arr[i].s).prop("selected", arr[i].s === option.options[0].s).appendTo(this.$select3);
					}

					//if (!this.$slider)
					//	this.$slider = $("<div></div").insertAfter(this.$div3).slider();
					//option = this._findOption(option.options, this.$select3.val(), "s");
					//this.$slider.slider("option", {
					//	min: option.min_fps,
					//	max: option.max_fps,
					//	value: 30 < option.min_fps ? option.min_fps : 30 > option.max_fps ? option.max_fps : 30
					//});
					if (!this.$select4)
						this.$select4 = $("<select></select").appendTo(this.$div4 = $menuContainer(this.$div3, "Fps"));
					this.$select4.empty();
					option = this._findOption(option.options, this.$select3.val(), "s");
					if (option) {
						for (var i = option.min_fps; i <= option.max_fps; i++)
							$("<option></option>").attr("value", i).text(i).prop("selected", i === 30 < option.min_fps ? option.min_fps : 30 > option.max_fps ? option.max_fps : 30).appendTo(this.$select4);
					}
					
					this.$dropdown.on("shown.bs.dropdown", function () {
						function childrenWidth($e) { var w = 0; $e.children().each(function () { w += $(this).outerWidth(true); }); return w; }
						var $e = $(this).find(".dropdown-menu .menu-container"), w = 0;
						$e.each(function () { var _w = childrenWidth($(this)); if (w < _w) w = _w; });
						$e.each(function () { var $this = $(this); if ($this.width() < w) $this.width(w); });
					});

				} else if (this.devices.length < 2) {
					this.$dropdown.css("visibility", "hidden");
				}
			};
			DirectShowDevice.prototype._updateUi = function(deviceName) {
				var $checkbox = $("#" + jqId(this.key)).prop("disabled", !deviceName);
				if (!deviceName)
					$checkbox.prop("checked", false);
				var $label = $("label[for=" + jqId(this.key) + "]");
				$label.attr("title", deviceName);
			};
			DirectShowDevice.prototype._updateFFmpeg = function(deviceName) {
				if (deviceName) {
					if (current_device_name[this.key] !== deviceName)
						renewFFmpeg(_op["capture_" + this.deviceType], this.key, deviceName, getRtmpUrl(getMyRtmpAppName(this.deviceType)));
				} else if (current_device_name[this.key]) {
					removeFFmpeg(this.key);
				}
			};
			
			// recreate UI
			var checkeds = getCheckeds();
			var $lineCont = $("#deviceContainer .boxHead + div").empty();
			var deviceTypes = [];
			// parse DirectShow output
			var re = /\[\s*dshow\s*@\s*[a-fA-F0-9]+\s*\]\s*"?(.*?)"?\s*\r?\n/ig, match, arr = [];
			while ((match = re.exec(res)) !== null) {
				arr.push(match[1]);
			}
			re = /^\s*Direct\s*Show\s*(video|audio)\s*devices\s*$/i;
			var re1 = /^\s*Could\s*not\s*enumerate\s*(video|audio)\s*devices\.?\s*$/i;
			// add DirectShow devices
			for (var i in arr) {
				if (re.test(arr[i])) {
					var deviceType = re.exec(arr[i])[1].toLowerCase();
					deviceTypes.push(DirectShowDevice.current = new DirectShowDevice(deviceType));
					$("<option></option>").attr({ "value": "", "disabled": "disabled" }).text(arr[i]).appendTo(DirectShowDevice.current.$select);
				} else if (re1.test(arr[i])) {
					$("<option></option>").attr({ "value": "", "disabled": "disabled" }).text(arr[i]).appendTo(DirectShowDevice.current.$select);
				} else {
					$("<option></option>").attr("value", arr[i]).text(arr[i]).appendTo(DirectShowDevice.current.$select);
					DirectShowDevice.current.devices.push({ name: arr[i], index: DirectShowDevice.current.devices.length });
				}
			}
			// add screen grab
			deviceTypes.push(new DeviceType("screen"));
			// sort deviceTypes
			deviceTypes.sort(function(a, b) {
				return deviceTypeOrder(a.deviceType) - deviceTypeOrder(b.deviceType);
			});
			// try to restore current devices
			var $line = $(lineHtml(getMyName())).appendTo($lineCont);
			for (var i = 0; i < deviceTypes.length; i++) {
				deviceTypes[i].appendTo($line).renew();
			}
			// refresh refresh button
			$("#deviceContainer .boxHead .ui-icon.ui-right").removeClass(arrowrefreshClassStr).addClass(arrowrefreshClasses[(ldCnt++) % 4]);
		});
	}
	// add refresh button click handler
	$("#deviceContainer .boxHead .ui-icon.ui-right").click(function () { listDevices(); event.stopPropagation(); });
	// list streams
	var lsCnt = 0;
	function listStreams () {
		$.when(
			$.ajax({
				url: 'http://' + rtmp_hostname + '/rtmp/stat',
				cache: false,
				dataType: "xml"
			}),
			$.ajax({
				url: 'http://' + rtmp_hostname + '/rest/vchat/' + encodeURIComponent(getMyName()) + '/' + encodeURIComponent(window.name),
				cache: false,
				dataType: 'json'
			})
		).then(function (data, data2) {
			var $xml = $(data[0]), $streams = $xml.find("rtmp > server > application:has(> name)").filter(function () { return $(this).find("> name").text() === "rtmp"; }).find("> live > stream:has(> publishing)");
			function getStreamType($stream) {
				var $video = $stream.find("> meta > video"), $audio;
				return parseFloat($video.find("> width").text()) > 0 && parseFloat($video.find("> height").text()) > 0 ? "video" : $stream.find("> meta > audio").has("*") ? "audio" : "unknown";
			}
			var checkeds = getCheckeds(), opName = "play";
			var $lineCont = $("#playbackContainer .boxHead + div").empty();
			for (var key in ffmpeg_ids) {
				var names = namesFromKey(key);
				if (names.opName === "play" && !checkeds[key]) {
					removeFFmpeg(key);
				}
			}
			var rtmpStreams = [], names = {};
			$streams.each(function (i, e) {
				var $e = $(e), rtmp_app = $e.find("name").text(), info = getStreamInfo(rtmp_app);
				rtmpStreams.push({ rtmp_app: rtmp_app, streamType: getStreamType($e), deviceType: info.deviceType, name: info.name });
				names[info.name] = true;
			});
			// add users from the REST service
			for (var i = 0; i < data2[0].length; i++) {
				var restName = data2[0][i];
				if (!names[restName]) {
					rtmpStreams.push({ rtmp_app: restName + "|audio", streamType: "audio", deviceType: "audio", name: restName, unconfirmed: true });
					names[restName] = true;
				}
			}
			// sort rtmpStreams
			rtmpStreams.sort(function(a, b) {
				return strCompare(a.name, b.name) || (deviceTypeOrder(a.deviceType) - deviceTypeOrder(b.deviceType)) || strCompare(a.deviceType, b.deviceType);
			});
			// add header
			function audioLevelIndicatorHtml(name) {
				var _name_hash = name.hashCode(), _level = audio_level[_name_hash], _css;
				if (_level != null)
					_css = audioLevelCss(_level);
				function cssToString(css) { var res = ""; for (var i in css) res += i + ":" + css[i] + ";"; return res; }
				return "<br /><span style='display:inline-block;width:100%;height:2px;" + (_css ? cssToString(_css) : "") + "' id='a" + _name_hash + "'></span>";
			}
			var name = "", $line, $contCheckboxes, cnt;
			for (var i = 0; i < rtmpStreams.length; i++) {
				var rtmpStream = rtmpStreams[i];
				if (name !== rtmpStream.name) {
					if ($contCheckboxes) {
						// add audio level indicator
						$(audioLevelIndicatorHtml(name)).appendTo($contCheckboxes);
					}
					name = rtmpStream.name;
					$line = $(lineHtml(name)).appendTo($lineCont);
					$contCheckboxes = $("<span style='display:inline-block;line-height:0px;margin-top:2px;'></span>").appendTo($line);
					cnt = 0;
				}
				// add missing devices
				var deviceOrder = deviceTypeOrder(rtmpStream.deviceType);
				if (deviceOrder > 0) {
					if (deviceOrder > ++cnt) { // insert before; process in this loop
						var deviceType = orderToDeviceType(cnt);
						rtmpStreams.splice(i, 0, rtmpStream = { rtmp_app: name + '|' + deviceType, streamType: deviceToStreamType(deviceType), deviceType: deviceType, name: name, unconfirmed: true });
					} else if (cnt < 3 && (i + 1 == rtmpStreams.length || name !== rtmpStreams[i + 1].name)) { // insert after; process in the next loop
						var deviceType = orderToDeviceType(cnt + 1);
						rtmpStreams.splice(i + 1, 0, { rtmp_app: name + '|' + deviceType, streamType: deviceToStreamType(deviceType), deviceType: deviceType, name: name, unconfirmed: true });
					}
				}
				if (rtmpStream.rtmp_app) {
					var $ffmpegUi = create$ffmpegUi(rtmpStream.deviceType, checkeds, "play", name).css("margin-left", "10px").appendTo(/*$line*/$contCheckboxes);
					if (rtmpStream.unconfirmed)
						$ffmpegUi.addClass("unconfirmed");
					var key = keyFromNames(rtmpStream.deviceType, "play", name);
					if (!checkeds[key]) {
						renewFFmpeg(_op["playback_" + rtmpStream.streamType], key, getRtmpUrl(rtmpStream.rtmp_app), "#video-chat-panel");
					}
				}
			}
			// add audio level indicator
			$(audioLevelIndicatorHtml(name)).appendTo($contCheckboxes);
			// refresh refresh button
			$("#playbackContainer .boxHead .ui-icon.ui-right").removeClass(arrowrefreshClassStr).addClass(arrowrefreshClasses[(lsCnt++) % 4]);
		}, function (error) {
			var err = error;
		});
	}
	function refreshStreams () {
		window.setTimeout(refreshStreams, 1000);
		listStreams();
	}
	// text chat
	$('#text-chat-text').keypress(function (e) {
		var code = e.keyCode || e.which;
		if (code === 13) {
			e.preventDefault();
			sendButtonClick();
		}
	}).focus();
	$('#text-chat-btn').click(sendButtonClick).button();
	function sendButtonClick() {
		var val = $trimVal('#text-chat-text');
		if (val)
		{
			$.ajax({
				url: textChatUrl(),
				method: 'PUT',
				data: JSON.stringify({ name: getMyName(), text: val }),
				cache: false,
				dataType: 'json'
			}).then(function (data) {
				//alert('sent...');
				$('#text-chat-text').val('');
				textChatText($textChatTxtCont, data);
			}, function (error) {
				var err = error;
			});
		}
	}
	var lastTextChatDataItem;
	function textChatUrl() { return 'http://' + rtmp_hostname + '/rest/tchat' + (lastTextChatDataItem ? '/' + lastTextChatDataItem.msec + '/' + lastTextChatDataItem.num : ''); }
	function textChatText($cont, data) {
		//$cont.empty();
		data.sort(function (a, b) { var res = a.msec - b.msec; return res != 0 ? res : a.num - b.num; });
		var showTs = $textChatTsCheckbox[0].checked;
		for (var i in data) {
			var item = lastTextChatDataItem = data[i];
			$('<p style="overflow:auto;line-height:1.2;font-size:90%;"></p>').prependTo($cont)
				.append($('<div class="tc-ts' + (showTs ? '' : ' hidden') + '" style="font-size:80%;/*margin-bottom:-3px;margin-top:3px;*/"></div>').text(new Date(item.msec).toLocaleString()))
				.append($('<strong></strong>').text(item.name + ': '))
				.append($('<span></span>').text(item.text));
		}
	}
	var tcCnt = 0;
	function textChat () {
		$.ajax({
			url: textChatUrl(),
			cache: false,
			dataType: 'json'
		}).then(function (data) {
			textChatText($textChatTxtCont, data);
			// refresh refresh button
			//$textChatHeadIcon.attr("class", "ui-icon ui-icon-arrowrefresh-1-" + cardinalPoints[(tcCnt++) % 4] + " ui-button ui-right");
			$textChatHeadIcon.removeClass(arrowrefreshClassStr).addClass(arrowrefreshClasses[(tcCnt++) % 4]);
		}, function (error) {
			var err = error;
		});
	}
	function refreshTextChat () {
		window.setTimeout(refreshTextChat, 500);
		textChat();
	}
	var $textChatHeadIcon = $('#textchatContainer .boxHead .ui-icon').click(function () {
		//textChat();
	}), $textChatTsCheckbox = $('#text-chat-timestamp').click(function () {
		$('.tc-ts')[this.checked ? 'removeClass' : 'addClass']('hidden');
	}), $textChatTxtCont = $('#textContainer');
	// start everything
	listDevices();
	refreshStreams();
	refreshTextChat();
}

// start the loop				
animate();

function animate() {
	requestAnimationFrame( animate );
	render();
}

function render() {
	for (var key in videos) {
		if (ffmpeg_ids[key] && (_applet.getSN || typeof(_applet.getSN) === "unknown")) {
			var sn_ = _applet.getSN(ffmpeg_ids[key]);
			if ( sn_ != sn && sn_ > 0 ) {
				sn = sn_;
				var dataURI = _applet.getDataURI(ffmpeg_ids[key]);
				// drop frames accumulated in the queue
/*
				while (_applet.getSN(ffmpeg_ids[key]) > sn) {
					console.log("dropped frame # " + sn);
					sn = _applet.getSN(ffmpeg_ids[key]);
					dataURI = _applet.getDataURI(ffmpeg_ids[key]);
				}
*/ // we do it in the applet now when drop-unused-frames="yes"
				// assign image src
				videos[key].drawUri(dataURI);
			}
		}
	}
}

$( document ).on( "click", ".dropdown-menu select", function(event) {
	event.stopPropagation();
});

$(function () {
	function resize() { $('.contCenter').each(function () { var $this = $(this); $this.css('margin-top', ($(document).height() - $this.height()) / 2); }); }
	$(window).resize(resize);
	resize();
});

$( document ).contextmenu({
	delegate: ".video-container",
	menu: [
		{ title: "Restore Original Size", cmd: "resize", uiIcon: "ui-icon-transfer-e-w" },
		{ title: "Bring To Front", cmd: "z-index", uiIcon: "ui-icon-newwin" },
	],
	select: function(event, ui) {
		//alert("select " + ui.cmd + " on " + ui.target);
		var $cont = ui.target.closest(".video-container");
		switch (ui.cmd) {
		case "resize":
			var size = $cont.data( "size" );
			$cont.width(size.width).height(size.height).triggerHandler( "resize", { size: size });
			break;
		case "z-index":
			var thisZ = 0, maxZ = 0;
			$(".video-container").each(function () { var $this = $(this), zInd = $this.css("z-index"); zInd = isNaN(zInd) ? 0 : parseInt(zInd); if ($cont[0] === this) thisZ = zInd; else if (zInd > maxZ) maxZ = zInd; });
			if (thisZ <= maxZ) {
				$cont.css("z-index", thisZ = maxZ + 1);
				if (thisZ > 85)
					$(".video-container").each(function () { var $this = $(this), zInd = $this.css("z-index"); if (!isNaN(zInd)) $this.css("z-index", parseInt(zInd) - 1); });
			}
			break;
		}
	}
});

$( "#video-chat-panel .contRightTop .boxHead" ).on( "click", function () {
	$(this).next("div").slideToggle();
});

</script>
</body>
</html>
